<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>로그인 처리 중 - Mindlog</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Noto Sans KR', sans-serif; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); min-height: 100vh; display: flex; align-items: center; justify-content: center; color: #fff; }
        .callback-container { text-align: center; padding: 2rem; }
        .spinner { width: 60px; height: 60px; border: 4px solid rgba(255, 255, 255, 0.1); border-top-color: #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 2rem; }
        @keyframes spin { to { transform: rotate(360deg); } }
        h1 { font-size: 1.5rem; font-weight: 500; margin-bottom: 0.5rem; color: #e6f1ff; }
        p { color: #8892b0; font-size: 0.95rem; }
        .error-container { display: none; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 12px; padding: 2rem; max-width: 400px; }
        .retry-btn { display: inline-block; padding: 0.75rem 2rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; border-radius: 8px; text-decoration: none; margin-top: 1.5rem; }
    </style>
</head>
<body>
<div class="callback-container">
    <div id="loading"><div class="spinner"></div><h1>로그인 처리 중...</h1><p>잠시만 기다려주세요.</p></div>
    <div id="error" class="error-container"><h2>로그인 실패</h2><p id="error-message">오류가 발생했습니다.</p><a href="/auth/login" class="retry-btn">다시 시도</a></div>
</div>
<script th:inline="javascript">
    (function() {
        const SUPABASE_URL = /*[[${supabaseUrl}]]*/ '';
        const SUPABASE_ANON_KEY = /*[[${supabaseAnonKey}]]*/ '';

        function startCallback() {
            if (typeof window.initSupabaseForTurbo === 'function') {
                window.initSupabaseForTurbo(SUPABASE_URL, SUPABASE_ANON_KEY);
                handleCallback();
            } else { setTimeout(startCallback, 50); }
        }

        async function handleCallback() {
            if (!window.supabaseClient) { setTimeout(handleCallback, 50); return; }
            try {
                const { data: { session }, error } = await window.supabaseClient.auth.getSession();
                if (error) throw error;
                if (session) {
                    document.cookie = `mindlog_access_token=${session.access_token}; path=/; max-age=3600; SameSite=Lax`;
                    window.location.href = '/diaries';
                } else {
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('error').style.display = 'block';
                }
            } catch (err) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error-message').textContent = err.message;
            }
        }
        startCallback();
    })();
</script>
</body>
</html>