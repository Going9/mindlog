<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>로그아웃 - Mindlog</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
        }
        .logout-container { text-align: center; padding: 2rem; }
        .spinner {
            width: 60px; height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 2rem;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        h1 { font-size: 1.5rem; font-weight: 500; margin-bottom: 0.5rem; color: #e6f1ff; }
        p { color: #8892b0; font-size: 0.95rem; }
    </style>
</head>
<body>
<div class="logout-container">
    <div class="spinner"></div>
    <h1>로그아웃 중...</h1>
    <p>잠시만 기다려주세요.</p>
</div>

<script th:inline="javascript">
    (function() {
        /*<![CDATA[*/
        const SUPABASE_URL = /*[[${supabaseUrl}]]*/ '';
        const SUPABASE_ANON_KEY = /*[[${supabaseAnonKey}]]*/ '';
        /*]]>*/

        // 1. 강제 종료 타이머 (어떤 상황에서도 1.5초 뒤에는 이동)
        const forceRedirect = setTimeout(() => {
            console.warn("로그아웃 작업이 지연되어 강제 이동합니다.");
            performLocalCleanup();
        }, 1500);

        function performLocalCleanup() {
            clearTimeout(forceRedirect);
            // 모든 로컬 데이터 삭제
            localStorage.removeItem('supabase_access_token');
            localStorage.removeItem('supabase_refresh_token');
            document.cookie = "mindlog_access_token=; path=/; expires=Thu, 01 Jan 1970 00:00:01 GMT;";
            // 로그인 페이지로 이동
            window.location.replace('/auth/login');
        }

        async function handleLogout() {
            try {
                // 2. 함수가 있는지 확인
                if (typeof window.initSupabaseForTurbo !== 'function') {
                    setTimeout(handleLogout, 50);
                    return;
                }

                window.initSupabaseForTurbo(SUPABASE_URL, SUPABASE_ANON_KEY);
                const client = window.supabaseClient;

                if (!client) {
                    setTimeout(handleLogout, 50);
                    return;
                }

                // 3. 서버 세션 종료 시도 (실패해도 무관)
                await client.auth.signOut().catch(e => console.warn("SignOut failed", e));

                // 4. 로컬 정리 및 이동
                performLocalCleanup();
            } catch (err) {
                console.error('Logout error:', err);
                performLocalCleanup();
            }
        }

        handleLogout();
    })();
</script>
</body>
</html>