<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>로그아웃 - Mindlog</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sunn-us/SUIT/fonts/static/woff2/SUIT.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'SUIT', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            background: radial-gradient(circle at 20% 10%, rgba(255, 255, 255, 0.85), rgba(255, 255, 255, 0) 40%),
                linear-gradient(160deg, #f7f7f4, #edf0ee);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #1f2937;
        }
        .logout-container {
            text-align: center;
            padding: 2rem 2.5rem;
            border-radius: 1rem;
            border: 1px solid rgba(86, 96, 107, 0.15);
            background: rgba(255, 255, 255, 0.78);
            box-shadow: 0 20px 40px -28px rgba(17, 24, 39, 0.4);
            backdrop-filter: blur(8px);
        }
        .spinner {
            width: 60px; height: 60px;
            border: 4px solid rgba(17, 24, 39, 0.1);
            border-top-color: #4b5563;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 2rem;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        h1 { font-size: 1.5rem; font-weight: 600; margin-bottom: 0.5rem; color: #1f2937; }
        p { color: #6b7280; font-size: 0.95rem; }
    </style>
</head>
<body>
<div class="logout-container">
    <div class="spinner"></div>
    <h1>로그아웃 중...</h1>
    <p>잠시만 기다려주세요.</p>
</div>

<script th:inline="javascript">
    (function() {
        /*<![CDATA[*/
        const SUPABASE_URL = /*[[${@environment.getProperty('mindlog.supabase.url')}]]*/ '';
        const SUPABASE_ANON_KEY = /*[[${@environment.getProperty('mindlog.supabase.anon-key')}]]*/ '';
        /*]]>*/

        // 1. 강제 종료 타이머 (1.5초 뒤 강제 이동)
        const forceRedirect = setTimeout(() => {
            console.warn("로그아웃 작업이 지연되어 강제 이동합니다.");
            performLocalCleanup();
        }, 1500);

        function performLocalCleanup() {
            clearTimeout(forceRedirect);

            // 1. 로컬 스토리지 삭제
            localStorage.removeItem('supabase_access_token');
            localStorage.removeItem('supabase_refresh_token');

            // 2. 쿠키 삭제 (만료일 과거로 설정하여 삭제)
            // [수정] SESSION 쿠키 삭제 추가 (Spring Session)
            document.cookie = "mindlog_access_token=; path=/; expires=Thu, 01 Jan 1970 00:00:01 GMT;";
            document.cookie = "SESSION=; path=/; expires=Thu, 01 Jan 1970 00:00:01 GMT;";
            document.cookie = "JSESSIONID=; path=/; expires=Thu, 01 Jan 1970 00:00:01 GMT;"; // 혹시 몰라 구버전도 삭제

            // 3. 로그인 페이지로 이동
            window.location.replace('/auth/login');
        }

        async function handleLogout() {
            try {
                if (!window.supabaseClient && window.supabase?.createClient) {
                    window.supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                }

                const client = window.supabaseClient;

                if (client?.auth?.signOut) {
                    // Supabase 세션 종료 시도 (실패해도 무관)
                    await client.auth.signOut().catch(e => console.warn("SignOut failed", e));
                }

                performLocalCleanup();
            } catch (err) {
                console.error('Logout error:', err);
                performLocalCleanup();
            }
        }

        handleLogout();
    })();
</script>
</body>
</html>
