<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{${viewLayout}}">
<head>
    <title>감정 인사이트</title>
</head>
<body>
<div layout:fragment="content" class="page-shell">
    <div class="flex flex-col md:flex-row justify-between items-center mb-2 gap-4">
        <div class="w-full md:w-auto text-center md:text-left">
            <h1 class="page-title">감정 인사이트</h1>
            <p class="page-subtitle mt-1">기간별 감정 태그 흐름을 확인해보세요</p>
        </div>
        <a th:href="@{/diaries}" class="btn-secondary">
            일기 목록
        </a>
    </div>

    <form method="get" th:action="@{/insights/emotions}" class="mb-6 surface-panel px-4 py-4 space-y-3" data-turbo-action="replace">
        <div class="flex flex-wrap items-end gap-3">
            <div class="flex items-center gap-2">
                <label for="from-date" class="text-sm font-medium text-stone-600 whitespace-nowrap">시작일</label>
                <input id="from-date" name="from" type="date" class="form-input py-2 px-3"
                       th:value="${from}"/>
            </div>
            <div class="flex items-center gap-2">
                <label for="to-date" class="text-sm font-medium text-stone-600 whitespace-nowrap">종료일</label>
                <input id="to-date" name="to" type="date" class="form-input py-2 px-3"
                       th:value="${to}"/>
            </div>
            <div class="flex items-center gap-2">
                <label for="top-n" class="text-sm font-medium text-stone-600 whitespace-nowrap">Top</label>
                <input id="top-n" name="topN" type="number" min="1" max="30" class="form-input py-2 px-3 w-24"
                       th:value="${topN}"/>
            </div>
            <button type="submit" class="btn-primary">적용</button>
        </div>
    </form>

    <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <div class="surface-panel p-4">
            <p class="text-xs font-semibold text-stone-400 uppercase tracking-wider">분석 기간</p>
            <p class="text-sm font-semibold text-stone-700 mt-2"
               th:text="${#temporals.format(analysis.fromDate, 'yyyy.MM.dd')} + ' - ' + ${#temporals.format(analysis.toDate, 'yyyy.MM.dd')}">
                2026.02.01 - 2026.02.11
            </p>
        </div>
        <div class="surface-panel p-4">
            <p class="text-xs font-semibold text-stone-400 uppercase tracking-wider">총 감정 언급</p>
            <p class="text-2xl font-bold text-stone-800 mt-2" th:text="${analysis.totalMentions}">0</p>
        </div>
        <div class="surface-panel p-4 border"
             th:each="category : ${analysis.categories}"
             th:with="
                isPositive=${category.category == 'POSITIVE'},
                isNegative=${category.category == 'NEGATIVE'},
                label=${isPositive ? '긍정 감정' : (isNegative ? '부정 감정' : '중립 감정')},
                borderColor=${isPositive ? 'var(--emotion-positive-soft)' : (isNegative ? 'var(--emotion-negative-soft)' : 'var(--emotion-neutral-soft)')},
                valueColor=${isPositive ? 'var(--emotion-positive-strong)' : (isNegative ? 'var(--emotion-negative-strong)' : 'var(--emotion-neutral-strong)')}
             "
             th:style="'border-color:' + ${borderColor} + '; background:linear-gradient(to bottom, #fffcfb 0%, #f8f6f3 100%);'">
            <p class="text-xs font-semibold tracking-wider" th:text="${label}" th:style="'color:' + ${valueColor}">긍정 감정</p>
            <p class="text-xl font-bold mt-2" th:text="${category.count}" th:style="'color:' + ${valueColor}">0</p>
            <p class="text-xs mt-1"
               th:style="'color:' + ${valueColor}"
               th:text="${#numbers.formatDecimal(category.ratio * 100, 1, 1)} + '%'">
                0.0%
            </p>
        </div>
    </div>

    <div th:if="${analysis.totalMentions == 0}" class="surface-panel p-8 text-center">
        <h3 class="text-sm font-semibold text-stone-900">분석할 감정 데이터가 없습니다</h3>
        <p class="mt-1 text-sm text-stone-500">기간을 넓히거나 감정 태그가 포함된 일기를 작성해보세요.</p>
    </div>

    <div th:unless="${analysis.totalMentions == 0}" class="grid lg:grid-cols-2 gap-6">
        <section class="surface-panel p-5">
            <h2 class="text-sm font-semibold text-stone-900 mb-4">카테고리 비율</h2>
            <div class="space-y-3" th:each="category : ${analysis.categories}"
                 th:with="
                    isPositive=${category.category == 'POSITIVE'},
                    isNegative=${category.category == 'NEGATIVE'},
                    label=${isPositive ? '긍정 감정' : (isNegative ? '부정 감정' : '중립 감정')},
                    barColor=${isPositive ? 'var(--emotion-positive)' : (isNegative ? 'var(--emotion-negative)' : 'var(--emotion-neutral)')}
                 ">
                <div class="flex items-center justify-between text-sm">
                    <span class="font-medium text-stone-700" th:text="${label}">긍정 감정</span>
                    <span class="text-stone-500"
                          th:text="${category.count} + ' (' + ${#numbers.formatDecimal(category.ratio * 100, 1, 1)} + '%)'">
                        0 (0.0%)
                    </span>
                </div>
                <div class="h-2 rounded-full bg-stone-100 overflow-hidden">
                    <div class="h-full"
                         th:style="'background-color:' + ${barColor} + '; width:' + (${category.ratio * 100}) + '%'"></div>
                </div>
            </div>
        </section>

        <section class="surface-panel p-5">
            <h2 class="text-sm font-semibold text-stone-900 mb-4">Top 태그</h2>
            <div class="space-y-2" th:if="${!#lists.isEmpty(analysis.topTags)}">
                <div class="flex items-center justify-between p-2 rounded-lg bg-white/70 border border-stone-100"
                     th:each="tag, stat : ${analysis.topTags}">
                    <div class="flex items-center gap-2">
                        <span class="text-xs text-stone-400 font-mono"
                              th:text="${stat.count}">1</span>
                        <span class="chip-soft text-xs"
                              th:style="'border-color:' + ${tag.color != null ? tag.color : '#6B7280'} + '; color:' + ${tag.color != null ? tag.color : '#6B7280'} + '; background-color: white;'"
                              th:text="${tag.name}">
                            태그
                        </span>
                        <span class="text-xs text-stone-400"
                              th:text="${tag.category == 'POSITIVE' ? '긍정 감정' : (tag.category == 'NEGATIVE' ? '부정 감정' : '중립 감정')}">
                            긍정 감정
                        </span>
                    </div>
                    <span class="text-sm font-semibold text-stone-700" th:text="${tag.count}">0</span>
                </div>
            </div>
            <p class="text-sm text-stone-500" th:if="${#lists.isEmpty(analysis.topTags)}">데이터가 없습니다.</p>
        </section>
    </div>

    <section th:unless="${analysis.totalMentions == 0}" class="surface-panel p-5 mt-6">
        <h2 class="text-sm font-semibold text-stone-900 mb-4">주간 카테고리 스택</h2>
        <div class="space-y-3">
            <div class="rounded-lg border border-stone-100 bg-white/80 p-3"
                 th:each="week : ${analysis.weeklyTrend}">
                <div class="flex items-center justify-between text-xs text-stone-500 mb-2">
                    <span th:text="${#temporals.format(week.weekStart, 'MM.dd')} + ' - ' + ${#temporals.format(week.weekEnd, 'MM.dd')}">02.10 - 02.16</span>
                    <span th:text="'총 ' + ${week.totalCount} + '건 / 평균강도 ' + ${#numbers.formatDecimal(week.avgIntensity, 1, 2)}">총 0건 / 평균강도 0.00</span>
                </div>
                <div class="h-3 w-full rounded-full overflow-hidden bg-stone-100 flex">
                    <div class="h-full"
                         th:style="'background-color:var(--emotion-positive); width:' + (${week.positiveRatio * 100}) + '%'"></div>
                    <div class="h-full"
                         th:style="'background-color:var(--emotion-negative); width:' + (${week.negativeRatio * 100}) + '%'"></div>
                    <div class="h-full"
                         th:style="'background-color:var(--emotion-neutral); width:' + (${week.neutralRatio * 100}) + '%'"></div>
                </div>
                <div class="mt-2 flex items-center gap-3 text-[11px] text-stone-500">
                    <span>긍정 <strong class="text-stone-700" th:text="${week.positiveCount}">0</strong></span>
                    <span>부정 <strong class="text-stone-700" th:text="${week.negativeCount}">0</strong></span>
                    <span>중립 <strong class="text-stone-700" th:text="${week.neutralCount}">0</strong></span>
                </div>
            </div>
        </div>
    </section>

    <section th:unless="${analysis.totalMentions == 0}" class="surface-panel p-5 mt-6">
        <h2 class="text-sm font-semibold text-stone-900 mb-4">일별 추이</h2>
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead>
                <tr class="text-left text-stone-500 border-b border-stone-200">
                    <th class="py-2">날짜</th>
                    <th class="py-2">긍정</th>
                    <th class="py-2">부정</th>
                    <th class="py-2">중립</th>
                    <th class="py-2">총합</th>
                    <th class="py-2">평균 강도</th>
                </tr>
                </thead>
                <tbody>
                <tr class="border-b border-stone-100"
                    th:each="point : ${analysis.dailyTrend}">
                    <td class="py-2 text-stone-700" th:text="${#temporals.format(point.date, 'MM.dd')}">02.11</td>
                    <td class="py-2" th:text="${point.positiveCount}">0</td>
                    <td class="py-2" th:text="${point.negativeCount}">0</td>
                    <td class="py-2" th:text="${point.neutralCount}">0</td>
                    <td class="py-2 font-semibold text-stone-700" th:text="${point.totalCount}">0</td>
                    <td class="py-2 text-stone-600"
                        th:text="${#numbers.formatDecimal(point.avgIntensity, 1, 2)}">0.00</td>
                </tr>
                </tbody>
            </table>
        </div>
    </section>
</div>
</body>
</html>
