# Mindlog 표준 근접화 기준선

## 1. 목적
- 브랜치: `release/web-starter-v1` 계열 작업 브랜치.
- 목표: Hotwire/Turbo/Stimulus/Spring MVC 기본 흐름을 유지하면서 Android WebView UX를 안정화한다.
- 범위: `로그인 + 홈 + 일기 CRUD`.

## 2. 잠금 규약
- 앱 판별: `source=app + 세션` 기반만 사용한다. User-Agent 추론 금지.
- Turbo 폼 규약: 성공 `303`, 검증 실패 `422` 유지.
- CSRF: 기본 활성화 유지, 예외 엔드포인트 확장은 문서 근거 필수.
- Turbo 전역(`turbo-init.js`): 부트스트랩, 401/403 처리, confirm 훅만 담당한다.
- UI 상호작용: Stimulus 컨트롤러로 분리한다.

## 3. 현재 UX 계약

### 3-1. 알림(Toast)
- 삭제/생성/수정 알림은 URL 쿼리(`noticeCode`)를 사용하지 않는다.
- 서버는 Flash attribute(`noticeCode`) 1회성 전달을 사용한다.
- 클라이언트는 `meta[name="mindlog-notice-code"]`를 소비한 뒤 즉시 제거한다.

### 3-2. 네비게이션 최소 로딩
- 웹(`mindlog`)은 최소 로딩 제어를 하지 않는다. (`diary_transition_controller` 제거)
- Android(`mindlog-android`)가 Hotwire 방문 lifecycle을 단일 상태머신으로 관리한다.
- 상태머신 기준 이벤트는 `onVisitStarted`(표시 시작), `onVisitCompleted/onVisitError...`(종료 신호)다.
- 종료 시점은 최소 표시시간 `500ms`를 만족할 때까지 지연하고, watchdog(`10s`)으로 stuck을 방지한다.
- 로딩 표현은 `MainActivity` 오버레이(`activity_main.xml`의 `native_transition_overlay`)를 사용한다.
- 오버레이 스피너 애니메이션은 `progress_spinner_delayed_fade_in.xml`의 `startOffset=0ms`를 유지한다.
- 적용 범위는 앱 내 Hotwire 방문 전체이며, 요청 5개 액션(이전 달/다음 달/최신순/오래된순/이동)과 리스트 -> 상세를 포함한다.

### 3-2-1. 네브바 복귀 상태
- 모바일 네브바는 메뉴 항목 클릭 시 즉시 닫지 않고, `turbo:before-render`에서 닫기 예약을 수행한다.
- `turbo:before-cache`, `turbo:load`에서는 강제로 닫힌 상태를 유지한다.
- Preline collapse API를 우선 사용하고, 실패 시 class/aria fallback으로 닫기 상태를 보장한다.

### 3-3. 확인 모달
- `Turbo.config.forms.confirm`은 커스텀 모달(`confirm-modal` Stimulus) 우선 사용.
- 예외 상황에서는 `window.confirm`으로 폴백한다.

### 3-4. 입력 UI
- 날짜 입력은 Flatpickr(`Y-m-d`)를 사용한다.
- 연/월/태그 카테고리는 `custom-select` Stimulus를 사용한다.
- 서버 파라미터 계약(`year`, `month`, `category`, `date`)은 그대로 유지한다.

## 4. 변경 금지
- `data-turbo="false"`를 문제 회피용으로 확대하지 않는다.
- 전역 `window.location` 강제 이동을 네비게이션 기본 전략으로 사용하지 않는다.
- 컨트롤러에서 성공 응답을 `200 + view`로 바꾸지 않는다.

## 5. 검증 게이트
- 자동 테스트: `./gradlew test`
- 수동 점검:
  - 삭제 후 알림 1회성 노출
  - 상세 뒤로가기 시 삭제 알림 재출력 없음
  - 삭제 버튼 즉시 로딩 표시
  - 리스트 -> 상세 이동에서 중첩 스피너 없이 전환 안정성 유지
  - 커스텀 confirm 취소/확인 동작
  - 커스텀 date/select 입력값 정상 제출
